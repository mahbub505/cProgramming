/*1326087236,176820665*/

if (window.CavalryLogger) { CavalryLogger.start_js(["EnN+h"]); }

__d("AvailableListConstants",[],function(c,e,f,d,b){var a={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_INITIALIZED:'available-list/initialized',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};window.AvailableListConstants=d.exports=a;},3);
__d("ChatConfig",["ChatConfigInitialData","copyProperties"],function(f,h,i,g,e){var b=h('ChatConfigInitialData');var d=h('copyProperties');var c={};var a=g.exports={get:function(k,j){return k in c?c[k]:j;},set:function(j){if(arguments.length>1){var k={};k[j]=arguments[1];j=k;}d(c,j);},getDebugInfo:function(){return c;}};a.set(b);},3);
__d("PresenceUtil",["cookie","Env","math-extensions","tx"],function(f,h,i,g,e){var a=h('cookie');var b=h('Env');var c=h('math-extensions');f.tx=h('tx');var d=c.rand32()+1;f.PresenceUtil=g.exports={checkMaintenanceError:function(j){if(j.getError()==1356007)return true;return false;},getErrorDescription:function(j){var l=j.getError();var k=j.getErrorDescription();if(!k)k="An error occurred.";if(l==1357001)k="Your session has timed out. Please log in.";return k;},getSessionID:function(){return d;},hasUserCookie:function(){return b.user===a.get('c_user');}};},3);
__d("dcode",[],function(d,f,g,e,c){var a,h={},b={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var j=[];for(var i in b){h[b[i]]=i;j.push(b[i]);}j.reverse();a=new RegExp(j.join("|"),'g');})();d.Dcode=e.exports={encode:function(i){return encodeURIComponent(i).replace(/([_A-Z])|%../g,function(k,j){return j?'%'+j.charCodeAt(0).toString(16):k;}).toLowerCase().replace(a,function(j){return h[j];});},decode:function(i){return decodeURIComponent(i.replace(/[_A-Z]/g,function(j){return b[j];}));}};},3);
__d("presence-cookie-manager",["cookie","dcode","JSLogger","json","PresenceInitialData","PresenceUtil","uri"],function(q,s,t,r,p){q.CookieManager=function(){};var a=s('cookie');var b=s('dcode');var c=s('JSLogger');s('json');var d=s('PresenceInitialData');var e=s('PresenceUtil');var f=s('uri');var o=d.cookieVersion;var h=d.dictEncode;var g='presence';var n={};var k=null;var l=null;var j=c.create('presence_cookie');function i(){try{var data=a.get(g);if(k===data){return l;}else{k=data;l=null;}if(data&&data.charAt(0)=='E')data=b.decode(data.substring(1));if(data){l=JSON.parse(data);return l;}}catch(u){j.warn('getcookie_error');}return null;}function m(){return parseInt(new Date().getTime()/1000,10);}q.presenceCookieManager=r.exports={register:function(v,u){n[v]=u;},store:function(){var u=i();if(u&&u.v&&o<u.v)return;var v={v:o,time:m()};for(var y in n)v[y]=n[y]();var x=JSON.stringify(v);if(h)x='E'+b.encode(x);if(e.hasUserCookie()){var w=f.getRequestURI(false).isSecure()&&!!a.get('csm');a.set(g,x,null,null,w);}},clear:function(){a.clear(g);},getSubCookie:function(v){var u=i();if(!u)return null;return u[v];}};},3);
__d("PresenceState",["JSLogger","math-extensions","presence-cookie-manager"],function(r,u,v,s,q){var b=u('JSLogger');var c=u('math-extensions');var t=u('presence-cookie-manager');var a=2000;var m=[];var l=[];var p=null;var d=null;var k=null;var n=0;var g=null;var o=0;var h=b.create('presence_state');function e(){clearTimeout(p);p=null;n=Date.now();t.store();i(k);}function f(){var y={ut:n};for(var w=0,x=m.length;w<x;w++)y=m[w](y);k=y;return k;}function i(x){o++;try{n=c.verifyNumber(x.ut);if(!d)d=setInterval(j,a);k=x;if(g===null)g=x;for(var i=0;i<l.length;i++)l[i](x);}catch(w){o--;throw w;}o--;}function j(){var w=t.getSubCookie('state');if(!w)return;if(w.ut>n){i(w);return;}}t.register('state',f);(function(){var x=t.getSubCookie('state');if(!x){h.debug('null_state');i(f());return;}try{i(x);}catch(w){h.error('load_exception',{e:w.toString()});i(f());}})();r.PresenceState=s.exports={doSync:function(w){if(o)return;if(w){e();}else if(!p)p=e.defer();},registerStateStorer:function(w){m.push(w);},registerStateLoader:function(w){l.push(w);},get:function(){return k;},getInitial:function(){return g;}};},3);
__d("presence-arbiter-message",[],function(b,d,e,c,a){b.PresenceMessage=c.exports={WINDOW_RESIZED:'presence/window-resized',TAB_CLOSED:'presence/tab-closed',TAB_OPENED:'presence/tab-opened',PRESENCE_UPDATER_READY:'presence/updater-ready',getAppMessageType:function(f,g){return 'presence/app_message:'+f+':'+g;},getArbiterMessageType:function(f){return 'presence/message:'+f;}};},3);
__d("PresencePrivacy",["arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","MercuryRequireEnsure","presence-arbiter-message","PresenceUtil"],function(zf,zn,zo,zh,ze){var a=zn('arbiter');var b=zn('AsyncRequest');var c=zn('ChannelConstants');var zc=zn('copyProperties');var d=zn('Env');var e=zn('JSLogger');var f=zn('MercuryRequireEnsure');var g=zn('presence-arbiter-message');var i=zn('PresenceUtil');if(zf.PresencePrivacy){zh.exports=zf.PresencePrivacy;}else{var m='/ajax/chat/privacy/settings.php';var n='/ajax/chat/privacy/online_policy.php';var o='/ajax/chat/privacy/visibility.php';var j='friend_visibility';var l='visibility';var k='online_policy';var zg={};var zp;var zj={};var zk;var zd;var zi;var zm=[];var zl=false;function p(){return e.create('blackbird');}var h=zc(new a(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function x(zr){var zq;for(zq in zr){var zs=zr[zq];if(zq==d.user){p().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(zs){case h.WHITELISTED:case h.BLACKLISTED:case h.UNLISTED:break;default:p().error('set_invalid_friend_visibility',{id:zq,value:zs});throw new Error("Invalid state: "+zs);}}for(zq in zr)zg[zq]=zr[zq];h.inform('privacy-changed');}function y(zq,zs){var zr={};zr[zq]=zs;x(zr);}function za(zq){switch(zq){case h.ONLINE:case h.OFFLINE:break;default:p().error('set_invalid_visibility',{value:zq});throw new Error("Invalid visibility: "+zq);}zp=zq;h.inform('privacy-changed');h.inform('privacy-user-presence-changed');a.inform('chat/visibility-changed',{sender:this});}function z(zq){switch(zq){case h.ONLINE_TO_WHITELIST:case h.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+zq);}zd=zq;h.inform('privacy-user-presence-changed');h.inform('privacy-changed');}function zb(zr,zq){zl=true;zr.send();}function w(zr,zq){zm.push({request:zr,data:zq});if(!zl){next=zm.shift();zb(next.request,next.data);}}function u(zq,zr){var zs=zq.type;if(zs===j){var zu=zr.payload.user_availabilities;h.inform('privacy-availability-changed',{user_availabilities:zu});for(var zt in zq.settings)zj[zt]=zq.settings[zt];}else{if(zs===l){zk=zq.visibility;}else if(zs===k)zi=zq.online_policy;h.inform('privacy-user-presence-response');}p().log('set_update_response',{data:zq,response:zr});}function r(zq,zr){if(zp!==zk)za(zk);if(zd!==zi)z(zi);zc(zg,zj);h.inform('privacy-changed');zm=[];p().log('set_error_response',{data:zq,response:zr});}function s(zq){zl=false;if(zm.length>0){next=zm.shift();zb(next.request,next.data);}}function v(zs,zr){if(i!=null){var zq=zs.getData();zq.window_id=i.getSessionID();zs.setData(zq);}zs.setHandler(u.bind(this,zr)).setErrorHandler(r.bind(this,zr)).setTransportErrorHandler(r.bind(this,zr)).setFinallyHandler(s.bind(this)).setAllowCrossPageTransition(true);return zs;}function q(zs,zq,zr){return v(new b(zs).setData(zq),zr);}function t(zu,zq){var zt=zq.obj;if(zt.viewer_id!=d.user){p().error('invalid_viewer_for_channel_message',{type:zu,data:zq});throw new Error("Viewer got from the channel is not the real viewer");}if(zt.window_id===i.getSessionID())return;var zr=zt.data;if(zt.event=='access_control_entry'){zr.target_ids.forEach(function(zv){y(zv,zr.setting);zj[zv]=zr.setting;});}else{if(zt.event=='visibility_update'){var zs=!!zr.visibility?h.ONLINE:h.OFFLINE;za(zs);zk=zs;}else if(zt.event=='online_policy_update'){z(zr.online_policy);zi=zr.online_policy;}h.inform('privacy-user-presence-response');}p().log('channel_message_received',{data:zq.obj});}zc(h,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(zs,zq,zr){zp=zk=zs;zd=zi=zq;zg=zc({},zr);zj=zc({},zr);zl=false;this.inform('initialized',this,a.BEHAVIOR_PERSISTENT);this.inform('privacy-changed');this.inform('privacy-user-presence-changed');p().log('initialized',{visibility:zs,policy:zq});a.inform('chat-visibility/initialized',this,a.BEHAVIOR_PERSISTENT);a.subscribe(g.getArbiterMessageType('privacy_changed'),t.bind(this));a.subscribe(c.ON_CONFIG,function(zu,zt){var zw=zt.getConfig('visibility',null);if(zw!==null&&typeof(zw)!=='undefined'){var zv=zw?h.ONLINE:h.OFFLINE;za(zv);p().log('config_visibility',{vis:zv});}}.bind(this));a.subscribe('channel/visibility-config',function(zt,zu){var zv=zu?h.ONLINE:h.OFFLINE;if(zv!=zp){za(zv);p().log('config_visibility_old_channel',{vis:zv});}}.bind(this));},setVisibility:function(zt){zk=zp;za(zt);var zq={visibility:zt};var zr={type:l,visibility:zt};var zs=q(o,zq,zr);w(zs,zr);p().log('set_visibility',{data:zq});return zt;},getVisibility:function(){return zp;},setOnlinePolicy:function(zt){zi=zd;z(zt);var zq={online_policy:zt};var zr={type:k,online_policy:zt};var zs=q(n,zq,zr);w(zs,zr);p().log('set_online_policy',{data:zq});return zt;},getOnlinePolicy:function(){return zd;},getFriendVisibility:function(zq){return zg[zq]||h.UNLISTED;},allows:function(zq){if(this.getVisibility()===h.OFFLINE)return false;var zr=this.getOnlinePolicy();return zr===h.ONLINE_TO_WHITELIST?zg[zq]==h.WHITELISTED:zg[zq]!=h.BLACKLISTED;},setFriendsVisibility:function(zu,zy){if(zu.length>0){var zx={};for(var zs=0;zs<zu.length;zs++){var zt=zu[zs];zj[zt]=zg[zt];zx[zt]=zy;}x(zx);var zw=zy;if(zw==h.UNLISTED)zw=zj[zu[0]];var zq={users:zu,setting:zy,setting_type:zw};var zr={type:j,settings:zx};var zv=q(m,zq,zr);w(zv,zr);p().log('set_friend_visibility',{data:zq});}return zy;},setFriendVisibilityMap:function(zs,zt){for(var zr in zs)zj[zr]=zg[zr];x(zs);var zq={type:j,settings:zs};w(v(zt,zq),zq);p().log('set_friend_visibility_from_map',{data:zs});},allow:function(zq){if(this.allows(zq)){p().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===h.OFFLINE){p().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var zr=this.getOnlinePolicy()===h.ONLINE_TO_WHITELIST?h.WHITELISTED:h.UNLISTED;return this.setFriendsVisibility([zq],zr);},disallow:function(zq){if(!this.allows(zq)){p().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===h.OFFLINE){p().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var zr=this.getOnlinePolicy()===h.ONLINE_TO_BLACKLIST?h.BLACKLISTED:h.UNLISTED;return this.setFriendsVisibility([zq],zr);},getBlacklist:function(){var zr=[];for(var zq in zg)if(zg[zq]===h.BLACKLISTED)zr.push(zq);return zr;},getWhitelist:function(){var zr=[];for(var zq in zg)if(zg[zq]===h.WHITELISTED)zr.push(zq);return zr;},getMapForTest:function(){return zg;},setMapForTest:function(zq){zg=zq;}});f.ensure(['PresencePrivacyInitialData'],function(zq){h.init.bind(h,zq.visibility,zq.onlinePolicy,zq.privacyData).defer();});zf.PresencePrivacy=zh.exports=h;}},3);
function ChatOptions(b,a){this._jslog=JSLogger.create('chat_options');this._jslog.log('server',{vis:b});this.visibility=!!b;this._lastVisibilityChangeTime=0;this.settings=a;}ChatOptions.prototype={load:function(){requireLazy(['ChatConfig','PresenceUtil','PresenceState','ChannelConstants','ChannelManager'],function(c,e,d,a,b){this._chatConfig=c;this._presenceState=d;d.registerStateStorer(this._storeState.bind(this));d.registerStateLoader(this._loadState.bind(this));if(!c.get('blackbird')){Arbiter.subscribe(a.ON_CONFIG,function(g,f){var h=b.getConfig('visibility');this._jslog.log('vis_chan_config',{new_vis:h});this.setVisibility(h);}.bind(this));Arbiter.subscribe('channel/visibility-config',function(f,g){this._jslog.log('vis_chan_config',{new_vis:g});this.setVisibility(g);}.bind(this));}Arbiter.subscribe(PresenceMessage.getArbiterMessageType('visibility'),function(f,g){var h=g.obj;if(h.window_id===e.getSessionID())return;this._jslog.log('vis_chan_message',{new_vis:h.visibility,window_id:h.window_id});this.setVisibility(h.visibility);}.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('setting'),function(f,g){var h=g.obj;if(h.window_id===e.getSessionID())return;this.setSetting(h.setting,!!h.value);}.bind(this));Arbiter.inform('chat-options/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);if(!c.get('blackbird')){this._jslog.log('define_vis_init',this.visibility);Arbiter.inform('chat-visibility/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);}}.bind(this));},_storeState:function(a){a.vis=this.visibility?1:0;a.vct=this._lastVisibilityChangeTime;a.bls=this.getSetting('sticky_buddylist');a.blc=this.getSetting('compact_buddylist');a.snd=this.getSetting('sound');return a;},_loadState:function(b){if(!this._chatConfig.get('blackbird')){var a=verifyNumber(b.vct);var c=Math.max(Env.rep_lag,this._chatConfig.get('presence_cookie_setting_cache_window'));if(new Date()-a<c&&this._lastVisibilityChangeTime<a){if(b.vis!=this.visibility){this._jslog.log('vis_load',{new_vis:b.vis});this.setVisibility(!!b.vis);}this._lastVisibilityChangeTime=a;}}this.setSetting('sticky_buddylist',b.bls);this.setSetting('compact_buddylist',b.blc);this.setSetting('sound',b.snd);},setVisibility:function(a){if(a===this.visibility)return;this.visibility=a;this._lastVisibilityChangeTime=Date.now();Arbiter.inform('chat/visibility-changed',{sender:this});this._presenceState.doSync();},_onVisibilityResponse:function(a){this._jslog.log('vis_send_success',{new_vis:a});if(a)this.setVisibility(a);},_onVisibilityError:function(a){this._jslog.log('vis_send_error',{old_vis:a});this.setVisibility(a);},toggleVisibility:function(){this.sendVisibility(!this.visibility);},sendVisibility:function(a){requireLazy(['PresenceUtil'],function(b){this._jslog.log('vis_send',{old_vis:this.visibility,new_vis:a});if(this.visibility==a)return;var c={visibility:a,notify_ids:Chat.getActiveFriendChats(),window_id:b.getSessionID()};if(!a)this.setVisibility(a);new AsyncRequest('/ajax/chat/visibility.php').setHandler(this._onVisibilityResponse.shield(this,a)).setErrorHandler(this._onVisibilityError.shield(this,!a)).setData(c).setAllowCrossPageTransition(true).send();Arbiter.inform(a?'chat/connect':'chat/disconnect');}.bind(this));},getSetting:function(a){return this.settings[a];},setSetting:function(a,b){if(this.getSetting(a)==b)return;this.settings[a]=b;Arbiter.inform('chat/option-changed',{name:a,value:b});}};
__d("ChatVisibility",["arbiter","ChatConfig","JSLogger","PresencePrivacy"],function(g,i,j,h,f){var a=i('arbiter');var b=i('ChatConfig');var d=i('JSLogger');var e=i('PresencePrivacy');var c={isOnline:function(){if(b.get('blackbird'))return e.getVisibility()===e.ONLINE;return window.chatOptions&&window.chatOptions.visibility;},goOnline:function(k){if(b.get('blackbird')){e.subscribe('initialized',function(){if(e.getVisibility()===e.OFFLINE){d.create('blackbird').log('chat_go_online');e.setVisibility(e.ONLINE);}k&&k();});return;}a.subscribe('chat-options/initialized',function(event,l){if(l.visibility){k&&k();}else{if(k)var m=a.subscribe('chat/visibility-changed',function(){a.unsubscribe(m);k();});l.sendVisibility(true);}});},canGoOffline:function(){var k=a.inform('live_listen_chat/go_offline');if(k===false){d.create('music_live_listen').log('can_go_offline',false);return false;}return true;},goOffline:function(k){if(!this.canGoOffline())return;if(b.get('blackbird')){e.subscribe('initialized',function(){if(e.getVisibility()===e.ONLINE){d.create('blackbird').log('chat_go_offline');e.setVisibility(e.OFFLINE);}k&&k();});return;}a.subscribe('chat-options/initialized',function(event,l){if(l.visibility){if(k)var m=a.subscribe('chat/visibility-changed',function(){a.unsubscribe(m);k();});l.sendVisibility(false);}else k&&k();});},toggleVisibility:function(){if(c.isOnline()){c.goOffline();}else c.goOnline();}};g.ChatVisibility=h.exports=c;},3);
__d("ShortProfiles",["arbiter","ArrayUtils","JSLogger","ObjectUtils","AsyncRequest","Env","util","copyProperties","MercuryRequireEnsure"],function(za,zc,zd,zb,z){var a=zc('arbiter');var b=zc('ArrayUtils');var e=zc('JSLogger');var g=zc('ObjectUtils');var c=zc('AsyncRequest');var d=zc('Env');var k=zc('util');var y=zc('copyProperties');var f=zc('MercuryRequireEnsure');var w={};var l=new a();var m=[];var q=false;var s=false;var t=e.create('short_profiles');function n(){if(!m.length||q)return;q=true;o.defer();}function x(ze){var zf=[];b.createFrom(ze).forEach(function(zg){var zm={};for(var zj=0,zl=zg.ids.length;zj<zl;zj++){var zk=zg.ids[zj];if(w[zk]){zm[zk]=w[zk];}else{zm=null;break;}}if(zm){var zn={};for(var zh in zm)zn[zh]=y({},zm[zh]);try{zg.fun(zn);}catch(zi){t.error('callback_error',{message:zi.message,stack:zi.stack});}}else zf.push(zg);});return zf;}function r(){q=false;n();}var i='/ajax/chat/user_info.php';var j='/ajax/chat/user_info_all.php';function o(zf){l.inform('fetch');var ze=x(m);m=[];if(!ze.length){r();return;}var zh={};ze.forEach(function(zi){zi.ids.forEach(function(zj){if(!w[zj])zh[zj]=true;});});var zg=g.getKeys(zh);new c(i).setData({ids:zg}).setHandler(function(zi){v(zi,ze);}).setErrorHandler(u).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}function v(zg,ze){for(var zf in zg.payload){var zi=zg.payload[zf];if(!zi.type)zi.type='friend';w[zf]=zi;}if(ze)x(ze);m=x(m);r();l.inform('updated');var zh=zg.getRequest().uri.getPath();if(zh==i){t.log('fetch_response');}else if(zh==j)t.log('fetch_response_all');}function u(){t.error('fetch_error');r();}function p(){if(!s){t.log('fetch_all');s=true;new c(j).setData({viewer:d.user}).setHandler(v).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}var h=y(l,{get:function(zf,ze){this.getMulti([zf],function(zg){ze(zg[zf],zf);});},getMulti:function(zg,zf){var ze={ids:zg,fun:zf};var zh=x([ze]);if(zh.length){m.push(ze);n();}},getNow:function(ze){var zf=w[ze];if(zf)return y({},zf);return null;},getCachedProfileIDs:function(){return keys(w);},hasAll:function(){return s;},fetchAll:function(){p();},set:function(ze,zf){var zg=w[ze];if(zg&&(zg.name!=zf.name||zg.firstName!=zf.firstName||zg.thumbSrc!=zf.thumbSrc))t.warn('changed',{oldInfo:zg,newInfo:zf});w[ze]=y({},zf);},setMulti:function(ze){for(var zf in ze)this.set(zf,ze[zf]);}});f.ensure(['InitialChatUserInfos'],function(ze){h.setMulti(ze);});za.ShortProfiles=zb.exports=h;},3);
__d("Chat",["arbiter","AsyncSignal","JSLogger","ObjectUtils","PresencePrivacy"],function(k,m,n,l,j){var a=m('arbiter');var b=m('AsyncSignal');var d=m('JSLogger');var e=m('ObjectUtils');var f=m('PresencePrivacy');function h(p,q){if(q&&q=='ordered_list'||q=='more_online_friends'||q=='online_friends'||q=='typeahead'){var o={target:p,source:q};new b('/ajax/chat/ct.php',o).send();}}var g={chatDisplay:'chat-display/loaded',buddyListDisplay:'buddylist-display/initialized',buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'};function i(p,o){a.subscribe(g[p],function(event,q){o(q);});}var c={openTab:function(o,p,r,q){if(window.External&&window.External.Chat&&window.External.Chat.openWindow)window.External.Chat.openWindow(o);h(o,q);m.ensure(['ChatConfig'],function(s){if(s.get('mercury_integration')){m.ensure(['MercuryThreads'],function(t){if(!r||r=='friend'){var u=t.getCanonicalThreadToUser(o);a.inform('chat/open-tab',{thread_id:u.thread_id});}});}else i('chatDisplay',function(t){t.focusTab(o,true,p,p,r);});});},openMultichatTab:function(r,p,o,s,t,q){i('chatDisplay',function(u){u.createMultichatTab(r,p,o,s,t,true,q);});},loadTabFragile:function(p,q,o,r){n(['ChatConfig'],function(s){if(s.get('mercury_integration')){n(['ChatController'],function(t){t.raiseFragileGroupTab(p);});}else i('chatDisplay',function(t){t.loadTabFragile(p,q,o,r);});});},openBuddyList:function(){i('buddyListNub',function(o){o.show();i('sidebar',function(p){p.enable();});});},closeBuddyList:function(){i('buddyListNub',function(o){o.hide();});},toggleSidebar:function(){i('sidebar',function(o){o.toggle();});},goOnline:function(o){n(['ChatVisibility'],function(p){p.goOnline(o);});},isOnline:function(){var o=null;n(['ChatVisibility'],function(p){o=p;});return o&&o.isOnline();},squelchTab:function(o,p){n(['ChatConfig'],function(q){if(q.get('mercury_integration')){n(['ChatTabPolicy','MercuryThreads'],function(r,s){var t=s.getCanonicalThreadToUser(o);r.squelch(t.thread_id);});}else i('chatDisplay',function(r){r.setSquelchedTab(o,true);r.closeTab(o);});});},unsquelchTab:function(o){i('chatDisplay',function(p){p.setSquelchedTab(o,false);});},getActiveChats:function(){if(!window.chatDisplay)return [];return e.getKeys(window.chatDisplay.tabs);},hasFocusedChat:function(){return window.chatDisplay&&window.chatDisplay.hasFocusedTab();},getActiveFriendChats:function(){var o=this.getActiveChats();return o.filter(function(p){return window.chatDisplay&&window.chatDisplay.tabs[p]&&window.chatDisplay.tabs[p].getPostType()=='friend';});},getLogger:function(o){return d.create(o);}};k.Chat=l.exports=c;},3);
__d("ServerTime",["PresenceInitialData"],function(e,g,h,f,d){var a=g('PresenceInitialData');var b;function c(i){b=Date.now()-i;}c(a.serverTime);e.ServerTime=f.exports={get:function(){return Date.now()-b;},getSkew:function(){return b;},update:function(i){c(i);}};},3);
__d("AvailableList",["arbiter","AvailableListConstants","ChannelConnection","ChannelConstants","Chat","ChatConfig","ChatVisibility","copyProperties","Env","isEmpty","JSLogger","ObjectUtils","Poller","PresencePrivacy","PresenceUtil","ServerTime","ShortProfiles","UserActivity","AvailableListInitialData"],function(zh,zzb,zzc,zs,zf){var a=zzb('arbiter');var c=zzb('AvailableListConstants');var e=zzb('ChannelConnection');var f=zzb('ChannelConstants');var g=zzb('Chat');var h=zzb('ChatConfig');var i=zzb('ChatVisibility');var ze=zzb('copyProperties');var j=zzb('Env');var zl=zzb('isEmpty');var l=zzb('JSLogger');var q=zzb('ObjectUtils');var r=zzb('Poller');var s=zzb('PresencePrivacy');var t=zzb('PresenceUtil');var v=zzb('ServerTime');var w=zzb('ShortProfiles');var x=zzb('UserActivity');var m=5;var p=60000;var u='/ajax/chat/buddy_list.php';var o=5000;var n=1800000;var d=.005;var zzd=0;var zt=0;var zza=false;var zy=null;var zp=null;var zq=null;var zd=null;var zo=0;var zn=0;var zz={};var zm=false;var zx={};var zw={};var zr={};var y=l.create('available_list');var b=ze({},c);function zg(zzj){var zzk=zzj||x.isActive(zq);return i.isOnline()?(zzk?zy:zp):null;}function z(zzl,zzj){var zzk=null;switch(zzl){case c.OFFLINE:zzk='offline';break;case c.IDLE:zzk='idle';break;case c.ACTIVE:zzk='active';break;case c.MOBILE:zzk='mobile';break;}y.rate(zzk,zzj);}function zze(){zd=null;a.inform(c.ON_AVAILABILITY_CHANGED);}function zb(zzj,zzn,zzk,zzm){if(zzj==j.user)return;switch(zzn){case c.OFFLINE:case c.IDLE:case c.ACTIVE:case c.MOBILE:break;default:return;}var zzl=b.get(zzj)!=zzn;if(zzk){zx[zzj]=v.get();zw[zzj]=zzm;}zz[zzj]=zzn;if(zzl){zzd++;if(!zd)zd=zze.defer();z(zzn,zzk);}}function zzg(zzj){zn=new Date();zr=Object.from(zzj);}function zzi(){if(b.haveFullList)a.inform(c.ON_UPDATED,b);}function zu(zzj){if(t.checkMaintenanceError(zzj))return;zt++;zza=false;if(zt>=m)a.inform(c.ON_UPDATE_ERROR);}function zv(zzm){var zzl=zzm.getPayload();var zzj=zzl.buddy_list;if(!zzj){zu(zzm);return;}v.update(zzl.time);b.updateTime=v.get();zt=0;zza=false;if(zzj.forcedRender)b.haveFullList=true;if(zzj.mobile_friends!=null)zzg(zzj.mobile_friends);var zzo=zzj.userInfos;if(zzo)w.setMulti(zzo);var zzk=zzj.nowAvailableList;var zzp=[];for(var zzn in zz)if(b.get(zzn)!==b.OFFLINE)zzp.push(zzn);zzp.forEach(function(zzq){z(b.OFFLINE,false);zz[zzq]=b.OFFLINE;});zm=zzj.userIsIdle;zzk&&b.addLegacyAvailableList(zzk);zx={};zw={};if(zzj.newAvailableList){b.presenceData=zzj.newAvailableList;b.haveFullList=true;}zzh();zze();zzi();}function zzf(zzl){if(e.isShutdown()||!i.isOnline()){b._poller.stop();return;}zo=new Date();var zzk=false;if(new Date()-zn>n)zzk=true;zza=true;var zzj=w.getCachedProfileIDs();zzl.setHandler(zv).setErrorHandler(zu).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:j.user,available_user_info_ids:zzj,fetch_mobile:zzk}).setURI(u).setAllowCrossPageTransition(true);}function zc(zzj,zzl){for(var zzk in zzj){var zzn;var zzm;if(zzl){zzn=c.legacyStatusMap[zzj[zzk].ol];zzm=zzj[zzk].s;}else if(!zzj[zzk]){zzn=c.OFFLINE;}else if(zzj[zzk].i){zzn=c.IDLE;}else if(zzj[zzk].m){zzn=c.MOBILE;}else zzn=c.ACTIVE;zb(zzk,zzn,zzl,zzm);}}function zzh(zzj){var zzk=zg(zzj);y.debug('update_poller',zzk);b._poller&&b._poller.setTimePeriod(zzk);}function za(){b.haveFullList=false;zo=0;zn=0;zz={};zw={};zx={};zr={};zzd++;zze();}function zk(){zzh();if(i.isOnline()){b.update();}else za();}function zi(){zzh();if(b._channelConnection.disconnected()){za();}else if(!b.haveFullList)b.update();}function zj(zzk,zzj){zzj.chat_config=h.getDebugInfo();zzj.available_list_debug_info={};b.getAvailableIDs().forEach(function(zzl){zzj.available_list_debug_info[zzl]=b.getDebugInfo(zzl);});zzj.available_list_poll_interval=b._poller&&b._poller.getTimePeriod();}ze(b,{haveFullList:false,init:function(zzr,zzl,zzq,zzp,zzm,zzj,zzk,zzo,zzn){this._chatConfig=h;this._channelConnection=e;b.updateTime=zzr;b.haveFullList=zzl;if(zzl&&zzo)zzg(zzo);b.addLegacyAvailableList(zzj);zy=zzp;zp=zzm;zq=zzn||300000;b._poller=new r(zg(),zzf,true);a.subscribe('chat-visibility/initialized',function(zzs){y.log('visibility_init',zzs);zzh(true);});a.subscribe(l.DUMP_EVENT,zj);a.subscribe(f.ON_CONNECT,b.update);x.subscribe(function(zzt,zzs){if(zzs.idleness>zy){y.debug('update_activity');b.update();}});if(h.get('blackbird')){s.subscribe('privacy-changed',zze);s.subscribe('privacy-availability-changed',function(zzt,zzs){for(var zzu in zzs.user_availabilities)this.set(zzu,zzs.user_availabilities[zzu]);}.bind(this));s.subscribe('privacy-user-presence-response',b.update);}else a.subscribe('chat/visibility-changed',zk);if(h.get('channel_disconnect_warning'))this._channelConnection.subscribe([this._channelConnection.CONNECTED,this._channelConnection.RECONNECTING,this._channelConnection.SHUTDOWN,this._channelConnection.MUTE_WARNING,this._channelConnection.UNMUTE_WARNING],zi);if(b.haveFullList)zo=new Date();a.inform.bind(a,c.ON_INITIALIZED,b,a.BEHAVIOR_PERSISTENT).defer();this.init=bagofholding;},get:function(zzj){if(zzj==j.user)return c.ACTIVE;var zzk=c.OFFLINE;if(zzj in zz)zzk=zz[zzj];if(this._chatConfig&&this._chatConfig.get('blackbird')&&!s.allows(zzj))zzk=c.OFFLINE;if(zzk==c.OFFLINE)if(zr[zzj])zzk=c.MOBILE;return zzk;},isUserIdle:function(){return zm;},isReady:function(){return b.haveFullList;},set:function(zzj,zzl,zzk){zb(zzj,zzl,true,null,zzk);},update:function(){if(new Date()-zo<o){!zza&&zzi.defer();return;}b._poller&&b._poller.requestNow();},getRev:function(){return zzd;},isIdle:function(zzj){return b.get(zzj)==c.IDLE;},getOnlineIDs:function(){var zzj,zzk=[];for(zzj in zz)if(b.get(zzj)===c.ACTIVE)zzk.push(zzj);return zzk;},getAvailableIDs:function(){var zzk=b.getOnlineIDs();var zzj;for(zzj in zr){if(zzj in zz)continue;zzk.push(zzj);}return zzk;},getOnlineCount:function(zzj){if(zzj&&!b.haveFullList)return 0;return b.getOnlineIDs().length;},addLegacyOverlay:function(zzj){zc(zzj,true);},addLegacyAvailableList:function(zzj){zc(zzj,false);},getDebugInfo:function(zzj){var zzk;if(window.ShortProfiles){var zzl=w.getNow(zzj);if(zzl)zzk=zzl.name;}return {id:zzj,presence:zz[zzj],overlaySource:zw[zzj],overlayTime:zx[zzj],overlaySource:zw[zzj],mobile:zr[zzj],name:zzk};}});var k=zzb('AvailableListInitialData');b.init(k.updateTime,true,k.updateOverlay,k.pollInterval,k.lazyPollInterval,k.availableList,k.availableCount,k.mobileFriends,k.lazyThreshold);zh.AvailableList=zs.exports=b;});
var ChatQuietLinks={silence:function(b){if(ua.firefox()>=4||ua.chrome())var a=Event.listen(document,'mousemove',function(){this._removeLinkHrefs(b);a.remove();}.bind(this));},_removeLinkHrefs:function(d){var c=DOM.scry(d,'a');for(var b=0;b<c.length;b++){var a=c[b].getAttribute('href');if(!a||a.charAt(0)=='#')c[b].removeAttribute('href');}}};
__d("GroupChatController",["arbiter","Chat","ChatConfig","ChatVisibility","dom","css-core","PageTransitions"],function(j,l,m,k,i){var a=l('arbiter');var c=l('Chat');var d=l('ChatConfig');var e=l('ChatVisibility');var f=l('dom');var b=l('css-core');var h=l('PageTransitions');function g(o,p,q){_goOnlineText=f.find(o,'.fbGroupChatGoOnline');_chatWithGroupText=f.find(o,'.fbGroupChatOpenTab');function n(){if(e.isOnline()){b.hide(_goOnlineText);b.show(_chatWithGroupText);}else{b.hide(_chatWithGroupText);b.show(_goOnlineText);}}_visibilitySubscription=a.subscribe('chat/visibility-changed',n);h.registerHandler(a.unsubscribe.bind(a,_visibilitySubscription));Event.listen(o,'click',function(){if(d.get('mercury_integration')){m(['ChatController'],function(r){r.raiseGroupTab(p);});}else e.goOnline(function(){c.openTab(p,q,'group');});});}k.exports=g;});
var ChatSidebar=window.ChatSidebar||(function(){var c=null;var a=null;var b=null;var e;var l=false;var m=false;var o=false;var n=false;var s;var r;var u;var y;var z;var q;var f=null;var w=null;var za=null;var p=JSLogger.create('blackbird');var d=32;function h(zb){switch(zb){case b.HINT_AUTH:return "Your session has timed out. Please log in.";case b.HINT_CONN:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});case b.HINT_MAINT:return _tx("Facebook {Chat} is currently down for maintenance.",{Chat:"Chat"});default:return _tx("Facebook {Chat} is currently unavailable.",{Chat:"Chat"});}}function g(zc){var zd;if(zc>c.get('warning_countdown_threshold_msec')){var zb=$N('a',{href:'#',className:'fbChatReconnectLink'},"Try again");zd=DOM._tx("Unable to connect to chat. {try-again-link}",{'try-again-link':zb});}else if(zc>1000){zd=_tx("Unable to connect to chat. Reconnecting in {seconds}...",{seconds:Math.floor(zc/1000)});}else zd="Unable to connect to chat. Reconnecting...";return zd;}function i(zd,zb){if(w){clearTimeout(w);w=null;}if(zd===a.SHUTDOWN){f=h(zb);}else if(zd===a.CONNECTED){f=null;}else if(zd===a.RECONNECTING){var zc=zb;f=g(zc);if(zc>1000){if(zc>c.get('warning_countdown_threshold_msec')){if(za){za.remove();za=null;}za=Event.listen(r,'click',function(event){if(CSS.hasClass(event.getTarget(),'fbChatReconnectLink')){a.reconnect();return false;}});}w=setTimeout(bind(null,i,zd,zc-1000),1000,false);}}j();}function j(){var zf=ChatVisibility.isOnline();var zb=false;if(!zf){var zc='fbChatGoOnlineLink';var ze=c.get('blackbird')?"Go online":"available";var zd=$N('a',{href:'#',className:zc},ze);var zg=c.get('blackbird')?DOM._tx("{=Go online} to see who's online to chat.",{'=Go online':zd}):DOM._tx("You are unavailable to chat. Let friends see you as {=available}?",{'=available':zd});DOM.setContent(r,zg);Event.listen(r,'click',function(event){if(CSS.hasClass(event.getTarget(),zc)){if(ChatVisibility.isOnline()){p.error('sidebar_go_online_while_online');p.rate('sidebar_go_online_error',c.get('blackbird'));}p.rate('sidebar_go_online',c.get('blackbird'));ChatVisibility.goOnline();return false;}});CSS.addClass(u,'offline');}else{CSS.removeClass(u,'offline');DOM.empty(r);if(a.disconnected()){CSS.addClass(u,'error');DOM.setContent(r,f);}else CSS.removeClass(u,'error');}t();}function k(){if(!ChatSidebar.isVisible()&&n)return;o=false;CSS.hide(u);CSS.removeClass(document.documentElement,'sidebarMode');s.hide();y.getCore().reset();p.rate('sidebar_hide',n);Arbiter.inform('sidebar/hide',ChatSidebar);}function t(){OrderedFriendsList.subscribe('initialized',function(){var zc=ChatSidebar.shouldShowSidebar();CSS.conditionClass(document.documentElement,'sidebarCapable',zc);if(ChatSidebar.isEnabled()&&zc){CSS.setStyle(u,'height',z.y+'px');v();var zb=z.y;$A(u.childNodes).forEach(function(zd){if(zd!==e)zb-=Vector2.getElementDimensions(zd).y;});CSS.setStyle(e,'height',zb+'px');this._maxItems=Math.floor((zb-8)/d);s.setNumTopFriends(this._maxItems);y.getData().setMaxResults(this._maxItems);Arbiter.inform('sidebar/resized',ChatSidebar);}else k();n=true;});}function v(){if(ChatSidebar.isVisible())return;o=true;CSS.show(u);CSS.addClass(document.documentElement,'sidebarMode');s.show();p.rate('sidebar_show',n);Arbiter.inform('sidebar/show',ChatSidebar);}function x(){chatOptions.setSetting('sidebar_mode',ChatSidebar.isEnabled());new AsyncRequest('/ajax/chat/settings.php').setHandler(bagofholding).setErrorHandler(bagofholding).setData({sidebar_mode:ChatSidebar.isEnabled()}).setAllowCrossPageTransition(true).send();}return {init:function(zc,zb,zd){ChatSidebar.init=bagofholding;requireLazy(['ChatConfig','ChannelConnection','ChannelConstants','ChatVisibility','PresencePrivacy'],function(zg,ze,zf,zh,zi){c=zg;a=ze;b=zf;ChatVisibility=zh;PresencePrivacy=zi;u=zc;s=zb;y=zd;e=DOM.find(zc,'div.fbChatSidebarBody');r=DOM.find(zc,'div.fbChatSidebarMessage div.message');zb.setScrollContainer(DOM.find(e,'div.uiScrollableAreaWrap'));zb.subscribe(['render','show','hide'],debounce(function(){var zj=zb.getRoot();var zk=ScrollableArea.getInstance(zj);zk&&zk.adjustGripper();}));ChatQuietLinks.silence(zc);Event.listen(window,'resize',t);Arbiter.subscribe('chat/option-changed',function(zk,zj){if(zj.name=="sidebar_mode"){l=!!chatOptions.getSetting('sidebar_mode');t();}});zd.subscribe(['respond','reset'],function(zj,zk){if(o)if(zk&&zk.value&&zk.value===zd.getCore().getValue()&&zd.getView().isVisible()){s.hide();}else s.show();});zd.getData().subscribe('beforeQuery',t);a.subscribe([a.CONNECTED,a.SHUTDOWN],i);if(c.get('channel_disconnect_warning')){a.subscribe(a.RECONNECTING,i);a.subscribe([a.MUTE_WARNING,a.UNMUTE_WARNING],j);}Arbiter.subscribe('buddylist-nub/initialized',function(zj,zk){Event.listen(zk.getButton(),'click',function(event){ChatSidebar.enable();return !ChatSidebar.shouldShowSidebar();});});Arbiter.subscribe('chat-options/initialized',function(zj,zk){l=!!zk.getSetting('sidebar_mode');Arbiter.subscribe('chat-visibility/initialized',function(zl){p.rate('sidebar_vis_init',c.get('blackbird'));j();Arbiter.subscribe('chat/visibility-changed',j);if(c.get('blackbird'))PresencePrivacy.subscribe('privacy-user-presence-changed',j);Arbiter.inform('sidebar/initialized',ChatSidebar,Arbiter.BEHAVIOR_PERSISTENT);});});});},disable:function(){if(!ChatSidebar.isEnabled())return;l=false;x();k();},enable:function(){if(ChatSidebar.isEnabled())return;l=true;x();t();!function(){if(ChatSidebar.isVisible())y.getCore().getElement().focus();}.defer();},hide:function(){m=true;k();},unhide:function(){m=false;t();},getBody:function(){return e;},getRoot:function(){return u;},getVisibleWidth:function(){return u&&u.offsetWidth||0;},isEnabled:function(){return l;},isViewportCapable:function(){z=Vector2.getViewportDimensions();return z.x>c.get('sidebar.minimum_width');},shouldShowSidebar:function(){return ChatSidebar.isViewportCapable()&&!m&&OrderedFriendsList.getList().length>c.get('sidebar.min_friends')&&!FbDesktopPlugin.shouldSuppressSidebar();},isVisible:function(){return o;},resize:t,toggle:function(){ChatSidebar.isEnabled()?ChatSidebar.disable():ChatSidebar.enable();}};})();
function VideoEvents(){}Function.mixin(VideoEvents,'Arbiter',{ACTIVATING:'videochat/activating',LOGGING_IN:'videochat/logging_in',GETTING_TOKEN:'videochat/getting_token',CONNECTING:'videochat/connecting',SLOW_CONDITIONS:'videochat/slow_conditions',CALL_INCOMING:'videochat/call_incoming',CALL_CONNECTED:'videochat/call_connected',GOT_CALLEE:'videochat/got_callee',CALL_HANDLED:'videochat/call_handled',CALLEE_ANSWERING:'videochat/callee_answering',FATAL_ERROR:'videochat/fatal_error',CALL_IN_PROGRESS:'videochat/call_in_progress',NOT_AVAILABLE:'videochat/not_available',SERVER_ERROR:'videochat/server_error',ACTIVATE_FAILED:'videochat/activate_failed',ACTIVATE_TIMED_OUT:'videochat/activate_failed_time',WRONG_VERSION_ERROR:'videochat/wrong_version',FATAL_PLUGIN_ERROR:'videochat/plugin_fatality',SILENT_PLUGIN_ERROR:'videochat/plugin_silent_fatality',START_CALL_UI:'videochat/start_call_ui',START_CALL:'videochat/start_call',ANSWER_CALL:'videochat/answer_call',IGNORE_CALL:'videochat/ignore_call',CANCEL_CALL:'videochat/cancel_call',INSTALL_STARTED:'videochat/install_started',INSTALL_COMPLETED:'videochat/install_completed',log:function(a){window.console&&console.log&&console.log(a);},warn:function(a){window.console&&console.warn&&console.warn(a);},error:function(a){window.console&&console.error&&console.error(a);}});
var VideoChatPlugin=function(){};Function.mixin(VideoChatPlugin,'Arbiter',{INSTALL_TYPES:{JAVA:0,MANUAL:1},isSupported:function(){var b=ua.windows()&&((ua.ie()>=7&&!ua.ie64())||ua.firefox()>=3.6||ua.chrome()>=5);var a=(ua.osx()>10.4)&&(ua.firefox()>=3.6||ua.chrome()>=5||ua.safari()>=500);return (b||a);},notifyFromApplet:function(b,a){Arbiter.inform(String(b),{args:String(a)});},isInstalled:function(){var a=false;if(VideoChatPlugin.isSupported())if(VideoChatPlugin.usesActiveX()){var c=null;try{c=new ActiveXObject('SkypeLimited.SkypeWebPlugin');a=!!c;}catch(b){}c=null;}else a=VideoChatPlugin._getInstalledVersion();return a;},usesActiveX:function(){return ua.ie()&&ua.windows()&&!ua.opera();},setLogger:function(a){VideoChatPlugin.log=a||bagofholding;},embed:function(a){Bootloader.loadComponents('VideoChatPluginCore',function(){VideoChatPlugin.embed(a);});},remove:bagofholding,_getInstalledVersion:function(){if(!navigator)return null;navigator.plugins.refresh(false);mimeHandler=navigator.mimeTypes['application/skypesdk-plugin'];return mimeHandler&&mimeHandler.enabledPlugin;}});
var VideoChatView={RINGTONE_PATH:'/sound/bling.mp3',WINDOW_NAME_COOKIE_KEY:'vcpwn',TARGET_ID_COOKIE_KEY:'vctid',inIncomingCall:false,inOutgoingCall:false,inManualInstall:false,tokens:[],init:function(){VideoChatView.subscribe(VideoEvents.CALL_INCOMING,VideoChatView._onIncomingCall);VideoChatView.subscribe(VideoEvents.START_CALL_UI,function(a,b){if(!VideoChatView.inOutgoingCall){VideoChatView.inOutgoingCall=true;if(VideoChatPlugin.isInstalled()){VideoChatView.onOutgoingCall(b.idTarget);}else VideoChatView._invokeCore('promptInstall',b.idTarget);}});if(VideoChatPlugin.isSupported())CSS.addClass(document.documentElement,'videoCallEnabled');onbeforeunloadRegister(function(){if((VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall)&&!VideoChatView.inManualInstall)return "Leaving this page will end your call.";});onleaveRegister(function(){if(VideoChatView.inIncomingCall||VideoChatView.inOutgoingCall){VideoEvents.inform(VideoEvents.CANCEL_CALL,{cause:'leave:page'});VideoChatView.inIncomingCall=false;VideoChatView.inOutgoingCall=false;}});VideoChatView._checkPriorState();},subscribe:function(b,a){VideoChatView.tokens.push(VideoEvents.subscribe(b,a));},onProfileButtonClick:function(a){VideoChatView._invokeCore('onProfileButtonClick',a);},unload:function(){while(VideoChatView.tokens.length)VideoEvents.unsubscribe(VideoChatView.tokens.pop());},mightReloadPostInstall:function(){return ua.windows();},_showDialog:function(b,a){new Dialog().setAllowCrossPageTransition(true).setTop(a?85:125).setAsync(new AsyncRequest(b)).show();},_onIncomingCall:function(a,b){VideoChatView.inIncomingCall=true;VideoChatView._showDialog(URI('/ajax/chat/video/incoming_call.php').setQueryData({idTarget:b.idTarget,callId:b.callId}),true);},onOutgoingCall:function(a){VideoChatView.inOutgoingCall=true;VideoChatView._showDialog('/ajax/chat/video/outgoing_call.php?idTarget='+a);},_checkPriorState:function(){if(VideoChatView.mightReloadPostInstall()){var a=getCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);if(a){clearCookie(VideoChatView.WINDOW_NAME_COOKIE_KEY);var b=getCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(b){clearCookie(VideoChatView.TARGET_ID_COOKIE_KEY);if(getCookie(VideoChatView.TARGET_ID_COOKIE_KEY))return;if(VideoChatPlugin.isInstalled())VideoChatView.onOutgoingCall(b);}}}},_invokeCore:function(b){var a=Array.prototype.slice.call(arguments,1);Bootloader.loadComponents('VideoChatViewCore',function(){VideoChatView.initCore();VideoChatView[b].apply(VideoChatView,a);});}};
function PresenceIndicator(){}PresenceIndicator.prototype={init:function(b,a,d){this._id=b;this._firstname=a;this._tooltip=d;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=JSLogger.create('presence_indicator');Arbiter.subscribe('chat-visibility/initialized',function(e){this._jslog.log('vis_init',e);this._updateVisibility();}.bind(this));this._subscriptions=[Arbiter.subscribe([AvailableListConstants.ON_AVAILABILITY_CHANGED],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];this._updateAvailability.bind(this).defer();var c=Event.listen(this._tooltip,'click',function(){requireLazy(['AvailableList'],function(e){if(this._previousAvail!=AvailableListConstants.OFFLINE)Chat.openTab(this._id);}.bind(this));}.bind(this));onleaveRegister(function(){c.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){requireLazy(['AvailableList','ChatConfig'],function(a,b){if(!a.isReady())return;var e;var d;var c=a.get(this._id);if(c===this._previousAvail)return;this._previousAvail=c;switch(c){case AvailableListConstants.OFFLINE:e=b.get('blackbird')?_tx("{name} is offline",{name:this._firstname}):_tx("{name} is unavailable",{name:this._firstname});d='offline';break;case AvailableListConstants.IDLE:e=_tx("{name} is idle",{name:this._firstname});d='idle';break;case AvailableListConstants.ACTIVE:e=b.get('blackbird')?_tx("{name} is online",{name:this._firstname}):_tx("{name} is available",{name:this._firstname});d='online';break;case AvailableListConstants.MOBILE:e=_tx("{name} is available on mobile",{name:this._firstname});d='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,e);CSS.setClass(this._image,d);}.bind(this));},_updateVisibility:function(){requireLazy(['ChatVisibility'],function(a){if(a.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}.bind(this));}};